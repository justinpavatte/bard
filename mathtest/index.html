<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DFY Math Test</title>
    <link rel="stylesheet" type="text/css" href="styles.css">   
</head>
<body>
    <div class="container">
        <h1>DFY Math Test</h1>
        <div id="intro">
            <div>
                <p id="welcomeMessage" style="color: #6d74c6;"></p>
            </div>
            <div style="text-align: center;">
                <p style="color: #AF7296;">Time remaining: <span id="timer"></span></p>
            </div>
        </div>
        <div style="margin-top: 20px;">
            <label class="wrap-label">If a ring is priced at $149.00, what would it cost the customer if we reduced it:</label>
        </div>
        <table style="margin-left: 20px;">
            <tr>
              <td><label for="q1">1. 20%</label></td>
              <td><input id="q1" type="text" pattern="^\d+(\.\d)?$" oninput="enforceOneDecimalPlace(event)" inputmode="numeric" class="small-input"/></td>
            </tr>
            <tr>
              <td><label for="q2">2. 50%</label></td>
              <td><input id="q2" type="text" pattern="^\d+(\.\d)?$" oninput="enforceOneDecimalPlace(event)" inputmode="numeric" class="small-input"/></td>
            </tr>
            <tr>
              <td><label for="q3">3. 30%</label></td>
              <td><input id="q3" type="text" pattern="^\d+(\.\d)?$" oninput="enforceOneDecimalPlace(event)" inputmode="numeric" class="small-input"/></td>
            </tr>
            <tr>
              <td><label for="q4">4. 1/10</label></td>
              <td><input id="q4" type="text" pattern="^\d+(\.\d)?$" oninput="enforceOneDecimalPlace(event)" inputmode="numeric" class="small-input"/></td>
            </tr>
            <tr>
              <td><label for="q5">5. 60%</label></td>
              <td><input id="q5" type="text" pattern="^\d+(\.\d)?$" oninput="enforceOneDecimalPlace(event)" inputmode="numeric" class="small-input"/></td>
            </tr>
        </table>
        <div>
            <label class="wrap-label">Convert these fractions into decimals:</label>
        </div>
        <table style="margin-left: 20px;">
            <tr>
              <td><label for="q6">6. 1/5</label></td>
              <td><input id="q6" type="text" pattern="^\d+(\.\d)?$" oninput="enforceOneDecimalPlace(event)" inputmode="numeric" class="small-input"/></td>
            </tr>
            <tr>
              <td><label for="q7">7. 1/4</label></td>
              <td><input id="q7" type="text" pattern="^\d+(\.\d)?$" oninput="enforceOneDecimalPlace(event)" inputmode="numeric" class="small-input"/></td>
            </tr>
            <tr>
              <td><label for="q8">8. 3/4</label></td>
              <td><input id="q8" type="text" pattern="^\d+(\.\d)?$" oninput="enforceOneDecimalPlace(event)" inputmode="numeric" class="small-input"/></td>
            </tr>
            <tr>
              <td><label for="q9">9. 1/3</label></td>
              <td><input id="q9" type="text" pattern="^\d+(\.\d)?$" oninput="enforceOneDecimalPlace(event)" inputmode="numeric" class="small-input"/></td>
            </tr>
        </table>
        <div>
            <label class="wrap-label">If sales tax is 9 cents on the dollar, what is the tax on:</label>
        </div>
        <table style="margin-left: 20px;">
            <tr>
              <td><label for="q10">10. $7.00</label></td>
              <td><input id="q10" type="text" pattern="^\d+(\.\d)?$" oninput="enforceOneDecimalPlace(event)" inputmode="numeric" class="small-input"/></td>
            </tr>
            <tr>
              <td><label for="q11">11. $150.00</label></td>
              <td><input id="q11" type="text" pattern="^\d+(\.\d)?$" oninput="enforceOneDecimalPlace(event)" inputmode="numeric" class="small-input"/></td>
            </tr>
            <tr>
              <td><label for="q12">12. $499.00</label></td>
              <td><input id="q12" type="text" pattern="^\d+(\.\d)?$" oninput="enforceOneDecimalPlace(event)" inputmode="numeric" class="small-input"/></td>
            </tr>
        </table>
        <div>
            <label class="wrap-label">If 20% down is required on layaways, what is the down payment on a ring costing:</label>
        </div>
        <table style="margin-left: 20px;">
            <tr>
              <td><label for="q13">13. $50.00</label></td>
              <td><input id="q13" type="text" pattern="^\d+(\.\d)?$" oninput="enforceOneDecimalPlace(event)" inputmode="numeric" class="small-input"/></td>
            </tr>
            <tr>
              <td><label for="q14">14. $99.00</label></td>
              <td><input id="q14" type="text" pattern="^\d+(\.\d)?$" oninput="enforceOneDecimalPlace(event)" inputmode="numeric" class="small-input"/></td>
            </tr>
            <tr>
              <td><label for="q15">15. $169.00</label></td>
              <td><input id="q15" type="text" pattern="^\d+(\.\d)?$" oninput="enforceOneDecimalPlace(event)" inputmode="numeric" class="small-input"/></td>
            </tr>
        </table>
        <div>
            <label for="q16" class="wrap-label" style="display: inline;">*BONUS* If sales tax is 9 cents on the dollar, and a customer offers you $100.00 for an item OUT THE DOOR, what is the TAX?</label>
            <input id="q16" type="text" pattern="^\d+(\.\d)?$" oninput="enforceOneDecimalPlace(event)" inputmode="numeric" class="small-input" style="height: 20px;"/>
        </div>
        <button id="sbmt">Submit</button>
    </div>
    <script src="deviceHelper.js"></script>
    <script src="telegramHelper.js"></script>
    <script src="todoistHelper.js"></script>
    <script>
        const queryParams = new URLSearchParams(window.location.search);
        const firstName = queryParams.get('first');
        const lastName = queryParams.get('last');
        const token = queryParams.get('token');
    
        if (!firstName || !lastName || !token) {
            const errorDiv = document.createElement('div');
            errorDiv.style.backgroundColor = '#9D3F4A';
            errorDiv.style.color = 'white';
            errorDiv.style.padding = '10px';
            errorDiv.style.textAlign = 'center';
            errorDiv.textContent = 'Error: Missing required query parameters (first, last, token).';
            document.body.prepend(errorDiv);
            throw new Error('Missing required query parameters');
        }
    
        const fullName = `${firstName} ${lastName}`;
        document.getElementById('welcomeMessage').textContent =
          `Hello ${firstName}, please complete the test to the best of your ability. We are dealing with money so please answer to two decimal places. Your progress will be automatically submitted if you do not complete the test in the allotted time. Do not refresh the page during the test. Thank you for applying at Diamonds for You!`;
    
        const correctAnswers = {
            q1: Math.sin(0) + 119.20,
            q2: Math.cos(0) + 73.50,
            q3: Math.tan(0) + 104.30,
            q4: Math.sin(0) + 134.10,
            q5: Math.cos(0) + 58.60,
            q6: Math.tan(0) + 0.2,
            q7: Math.sin(0) + 0.25,
            q8: Math.sin(0) + 0.75,
            q9: Math.sin(0) + 0.333,
            q10: Math.sin(0) + 0.63,
            q11: Math.sin(0) + 13.50,
            q12: Math.sin(0) + 44.91,
            q13: Math.sin(0) + 10.00,
            q14: Math.sin(0) + 19.80,
            q15: Math.sin(0) + 33.80,
            q16: Math.cos(0) + 7.26
        };
    
        const inputs = document.querySelectorAll('input');
        const submitButton = document.getElementById('sbmt');
        const timerDisplay = document.getElementById('timer');
    
        // —— PERSISTENT TIMER SETUP ——
        const allottedTime = 15 * 1000; // 15 minutes in ms
        let startTime, submitted = false;
    
        const storedStart = localStorage.getItem('dfyTestStart');
        if (storedStart) {
          startTime = new Date(parseInt(storedStart, 10));
        } else {
          startTime = new Date();
          localStorage.setItem('dfyTestStart', startTime.getTime());
        }
    
        // If we've already submitted, immediately show results
        if (localStorage.getItem('dfyTestSubmitted')) {
          submitted = true;
          submitTest();
        }
    
        function updateTimerDisplay() {
            const elapsed = Date.now() - startTime.getTime();
            const remaining = allottedTime - elapsed;
            if (remaining <= 0) {
                clearInterval(timerInterval);
                submitTest();
            } else {
                const m = Math.floor(remaining / 60000);
                const s = Math.floor((remaining % 60000) / 1000);
                timerDisplay.textContent = `${m}:${s < 10 ? '0' : ''}${s}`;
            }
        }
    
        let timerInterval;
        function startTimer() {
            timerInterval = setInterval(updateTimerDisplay, 1000);
            updateTimerDisplay();
        }
    
        // —— TEST INITIALIZATION ——
        (async function initializeTest() {
            try {
                const taskExists = await TodoistHelper.taskExists(token);
                if (!taskExists) {
                    window.location.href = "invalidtoken.html";
                    return;
                }
    
                TodoistHelper.completeTask(token);
                TelegramHelper.sendMessage(`${fullName} has started the test.`);
    
                // Only start or auto-submit based on persisted state
                const elapsed = Date.now() - startTime.getTime();
                if (!submitted) {
                    if (elapsed >= allottedTime) {
                        submitTest();
                    } else {
                        startTimer();
                    }
                }
            } catch (error) {
                console.error("Error during test initialization:", error);
                window.location.href = "invalidtoken.html";
            }
        })();
    
        function valuesRoughlyEqual(userVal, correctVal) {
            const uf = parseFloat(userVal);
            if (isNaN(uf)) return false;
            return Math.round(uf * 100) === Math.round(correctVal * 100);
        }
    
        function submitTest() {
            if (submitted) return;
            submitted = true;
            localStorage.setItem('dfyTestSubmitted', 'true');
    
            clearInterval(timerInterval);
            submitButton.disabled = true;
            document.getElementById('intro').style.display = 'none';
    
            const totalQ = Object.keys(correctAnswers).length - 1;
            let score = 0;
            const answers = [];
    
            inputs.forEach(input => {
                const id = input.id;
                if (!id.startsWith('q')) return;
    
                const userAnswer = input.value.trim();
                const correct = correctAnswers[id];
                const existing = input.parentNode.querySelector('.correct-answer');
                if (existing) existing.remove();
    
                if (id !== 'q16' && valuesRoughlyEqual(userAnswer, correct)) {
                    score++;
                } else if (id !== 'q16') {
                    input.style.border = '2px solid #9D3F4A';
                    const lbl = document.createElement('span');
                    lbl.className = 'correct-answer';
                    lbl.textContent = correct.toFixed(2);
                    lbl.style.color = '#9D3F4A';
                    lbl.style.marginLeft = '2px';
                    input.parentNode.appendChild(lbl);
                }
    
                if (id === 'q16' && !valuesRoughlyEqual(userAnswer, correctAnswers.q16)) {
                    input.style.border = '2px solid #9D3F4A';
                    const bonusLbl = document.createElement('span');
                    bonusLbl.className = 'correct-answer';
                    bonusLbl.textContent = correctAnswers.q16.toFixed(2);
                    bonusLbl.style.color = '#9D3F4A';
                    bonusLbl.style.marginLeft = '2px';
                    input.parentNode.appendChild(bonusLbl);
                }
    
                answers.push({ question: id, userAnswer, correctAnswer: correct });
            });
    
            const pct = ((score / totalQ) * 100).toFixed(0);
            const bonusCorrect = valuesRoughlyEqual(
                document.getElementById('q16').value,
                correctAnswers.q16
            );
            const bonusStatus = bonusCorrect ? 'BONUS ✅' : 'BONUS ❌';
    
            let resultHTML = `
                <p style="font-size:2em; text-align:center; margin:0.3em 0;">
                  <strong>Score: ${score}/${totalQ} (${pct}%)</strong>
                </p>`;
            if (bonusCorrect) {
                resultHTML += `
                <p style="text-align:center; font-size:1.5em; color:#777a5a; margin:0.3em 0;">
                  <strong>Bonus correct! Great job!</strong>
                </p>`;
            }
            resultHTML += `
                <p style="text-align:center; font-size:1.2em; margin:0.3em 0;">
                  Thanks for taking the test ${firstName}!
                </p>`;
    
            submitButton.outerHTML = resultHTML;
            window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
    
            TelegramHelper.sendMessage(
              `${fullName} completed the test.\nScore: ${pct}%\n${bonusStatus}`
            );
    
            TodoistHelper.createTask(`${fullName} - ${score}/${totalQ} - ${pct}% - ${bonusStatus}`)
              .then(taskId => {
                (async () => {
                  const lines = answers.map((ans, i) => {
                    const ok = valuesRoughlyEqual(ans.userAnswer, ans.correctAnswer);
                    const emoji = ok ? '✅' : '❌';
                    let qnum = `${i+1}.`;
                    if (i === answers.length - 1) qnum = 'Bonus:';
                    return `${emoji} ${qnum} User answer: ${ans.userAnswer} (Correct: ${ans.correctAnswer.toFixed(2)})`;
                  });
                  lines.push(DeviceHelper.getDeviceInfo());
                  await TodoistHelper.createComment(taskId, lines.join('\n'));
                })();
              });
        }
    
        inputs.forEach(input => {
            input.oninput = e => enforceOneDecimalPlace(e);
        });
        function enforceOneDecimalPlace(e) {
            const val = e.target.value;
            if (!/^\d*\.?\d*$/.test(val) || (val.match(/\./g)||[]).length > 1) {
                e.target.value = val.slice(0, -1);
            }
        }
    
        submitButton.onclick = () => submitTest();
    
        window.addEventListener('beforeunload', e => {
            if (!submitted) {
                e.preventDefault();
                e.returnValue = 'Are you sure you want to leave? Your test will not be submitted.';
            }
        });
    </script>    
</body>
</html>